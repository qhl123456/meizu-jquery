<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>确认订单-魅族商城</title>
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/cart.css" />
    <link rel="stylesheet" href="css/compute.css" />
    <script src="js/jQuery.js"></script>
    <script src="js/index.js"></script>
  </head>

  <body>
    <div id="cart-header">
      <div class="cart-header-container clear">
        <div class="cart-header-logo">
          <a href="index.html">
            <img src="img/header/logo_b.png" alt="" />
          </a>
        </div>
        <ul class="cart-header-flow">
          <li>购物车</li>
          <li class="cart-header-flow-active">确认订单</li>
          <li>在线支付</li>
          <li>完成</li>
        </ul>
        <ul class="cart-header-right">
          <li><a href="#">我的订单</a></li>
          <li>
            <a href="login.html">登录</a>
          </li>
          <li><a href="register.html">注册</a></li>
          <li class="logout">
            <a href="javascript:;" class="cart-header-username"> </a>
            <a href="javascript:;">地址管理</a>
            <a href="javascript:;">我的收藏</a>
            <a href="javascript:;">我的回购金</a>
            <a href="javascript:;">问题反馈</a>
            <a href="">退出登录</a>
          </li>
        </ul>
      </div>
    </div>
    <!-- 添加地址 -->
    <div class="adder-mask">
      <div class="address-adder">
        <div class="address-adder-title">添加新地址</div>
        <div class="address-adder-cancel">X</div>
        <div class="address-adder-main">
          <div class="address-adder-warp">
            <div class="address-adder-content">
              <div class="address-adder-content2">
                <div class="address-adder-row clear">
                  <div class="address-adder-title-l">
                    收货人姓名
                    <i class="require">*</i>
                  </div>
                  <div class="address-input-warp">
                    <input
                      type="text"
                      name=""
                      id=""
                      class="mz-input address-adder-name"
                      placeholder="姓名长度不超过15个文字"
                      required
                    />
                    <span class="require-name">请输入收件人姓名！</span>
                  </div>
                  <div class="address-adder-title-l">
                    收货人手机号 <i class="require">*</i>
                  </div>
                  <div class="address-input-warp">
                    <input
                      type="text"
                      name=""
                      id=""
                      class="mz-input address-adder-phone"
                      placeholder="请输入11位手机号"
                      required
                    />
                    <span class="require-phone">请输入手机号码！</span>
                  </div>
                </div>
                <div class="select_wrap">
                  <div class="select-title">
                    收货人地址 <i class="require">*</i>
                  </div>
                  <select id="province">
                    <option value="">省份/直辖市</option>
                  </select>
                  <select id="city">
                    <option value="">城市</option>
                  </select>
                  <select id="county">
                    <option value="">区/县</option>
                  </select>
                </div>
                <div class="address-adder-row">
                  <div class="address-adder-title-l">
                    详细地址<i class="require">*</i>
                  </div>
                  <div class="address-input-warp">
                    <input
                      type="text"
                      name=""
                      id=""
                      class="mz-input address-adder-detail"
                      placeholder="请输入4-50个文字的详细地址，例如路名、门牌号"
                      required
                    />
                    <span class="require-address">请输入详细地址！</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="address-adder-bottom">
          <div class="address-btn-success">确认</div>
          <div class="address-btn-cancel">取消</div>
        </div>
      </div>
    </div>
    <!-- 购物区域 -->
    <div class="order">
      <div class="order-container">
        <div class="order-address">
          <div class="order-address-title">收货人信息</div>
          <ul class="order-address-list">
            <li class="order-address-checkbox" style="display: none">
              <div class="order-address-checkbox-top">
                <!-- 收货人姓名 -->
                <div class="order-address-checkbox-name"></div>

                <!-- 收货人手机号 -->
                <div class="order-address-checkbox-phone"></div>
              </div>
              <!-- 收货人地址 -->
              <div class="order-address-checkbox-content"></div>

              <!-- 选中按钮 -->
              <input type="checkbox" checked class="select" />
              <!-- 编辑删除按钮 -->
              <div class="order-edit-address">
                <a href="javascript:;" class="edit">编辑</a>
                <a href="javascript:;" class="remove">删除</a>
              </div>
            </li>
            <!-- 添加地址对话框 -->
            <li class="order-address-checkbox add">
              <em class="iconfont">+</em>
              <div class="order-address-text">添加新地址</div>
            </li>
          </ul>
        </div>
        <div class="order-product">
          <div class="order-product-title">确认订单信息</div>
          <div class="order-product-list">
            <table class="order-product-table" cellpadding="0" cellspacing="0">
              <thead>
                <tr>
                  <th class="order-product-table-name">供应商：魅族</th>
                  <th class="order-product-table-price">单价</th>
                  <th class="order-product-table-num">数量</th>
                  <th class="order-product-table-total">小计</th>
                  <th class="order-product-table-express">配送方式</th>
                </tr>
              </thead>
              <tbody class="goodsDetail"></tbody>
              <tfoot>
                <tr class="order-product-footer">
                  <!-- 商品信息区 -->
                  <!-- 发票区 -->
                  <td class="order-product-info" colspan="3">
                    <div class="order-product-invoice clearfix">
                      <div class="order-prod-invoice-type">
                        发票类型：电子发票
                        <div class="order-product-invoice-icon"></div>
                      </div>
                      <span class="order-product-invoice-edit">修改</span>
                      <div class="order-product-invoice-info">
                        <p>
                          发票抬头：
                          <span class="order-product-invoice-title"
                            >默认为收货人姓名</span
                          >
                        </p>
                      </div>
                    </div>
                  </td>
                  <!-- 商品总价区 -->
                  <td class="order-product-total" colspan="2">
                    合计：
                    <span class="order-product-price"></span>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <!-- 优惠区域 -->
        <div class="order-discount">
          <div class="order-discount-title">使用优惠抵扣</div>
          <div class="order-discount-list">+ 使用回购金</div>
          <div class="order-discount-list">+ 使用礼品卡</div>
        </div>
        <!-- 选择支付区 -->
        <div class="order-total">
          <div class="order-total-pay">
            <div class="order-total-pay-title">选择支付方式</div>
            <!-- 支付方式 -->
            <div class="order-total-pay-cont">
              <!-- 快捷支付 -->
              <div class="order-total-pay-cont1">
                <div class="order-total-pay-cont-title">快捷支付</div>
                <ul>
                  <li><img src="img/computed/pay1.png" /></li>
                  <li><img src="img/computed/pay2.png" /></li>
                </ul>
              </div>
              <!--银行支付  -->
              <div class="order-total-pay-cont1">
                <div class="order-total-pay-cont-title">网上银行</div>
                <ul>
                  <li><img src="img/computed/pay3.png" /></li>
                  <li><img src="img/computed/pay4.png" /></li>
                  <li><img src="img/computed/pay5.png" /></li>
                  <li><img src="img/computed/pay6.png" /></li>
                  <li><img src="img/computed/pay7.png" /></li>
                  <li><img src="img/computed/pay8.png" /></li>
                </ul>
              </div>
            </div>
          </div>
          <!-- 底部支付区域 -->
          <div class="order-total-content">
            <div class="order-total-row">
              总金额：
              <div class="order-total-price"></div>
            </div>
            <div class="order-total-row">
              运费：
              <div class="order-total-fre">0.00</div>
            </div>
            <div class="order-total-row">
              应付：
              <div class="order-total-pay1"></div>
            </div>
            <div class="order-total-row">
              <div class="order-total-btn">下单并支付</div>
            </div>
            <div class="order-stock-tips-wrap">
              <div class="order-stock-tips">
                该订单含付款减库存商品，支付完成后才会为您预留库存！
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- 返回顶部 -->
    <div class="aside">
      <div class="message"></div>
      <div class="backTop"></div>
    </div>
    <!-- 提示用户填写地址 -->
    <div class="alert">
      <p class="title">
        提示
        <span>x</span>
      </p>
      <div class="content">请选择收货人地址</div>
      <a href="javascript:;" class="ok">确定</a>
    </div>
  </body>
</html>
<script>
  $(function () {
    let username = localStorage.getItem("username");
    // 判断用户名是否存在
    $(".logout:last-child").click(() => {
      localStorage.removeItem("username");
    });

    //判断用户是否是直接点击了立即购买
    function getQueryStringChinese(name) {
      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
      var r = window.location.search.substr(1).match(reg);
      if (r != null) return decodeURI(r[2]);
      return null;
    }
    let goodsId = getQueryStringChinese("goodsId");
    let count = getQueryStringChinese("goodsCount");
    let selectColor = getQueryStringChinese("goodsSelectColor");
    console.log(selectColor, goodsId, count);
    if (username) {
      $(".cart-header-right li").eq(1).hide();
      $(".cart-header-right li").eq(2).hide();
      $(".cart-header-right li").eq(0).show();
      $(".cart-header-right li").eq(3).css({
        display: "block",
        display: "flex",
      });
      $(".cart-header-username").html("用户" + username + "的商城");
      $(".cart-header-right li")
        .eq(3)
        .children("a")
        .eq(0)
        .show()
        .siblings()
        .hide();
      $(".cart-header-right li")
        .eq(3)
        .children("a")
        .eq(0)
        .mouseenter(function () {
          $(this).parent().addClass("user-list");
          $(this).siblings().show();
        });

      $(".logout").on("mouseleave", function () {
        $(this).removeClass("user-list");
        $(this).children("a").eq(0).siblings().hide();
      });

      if (goodsId) {
        $.ajax({
          url: "./getGoodsInfo.php",
          method: "get",
          data: { goodsId },
          success(res) {
            GoBuy(JSON.parse(res));
          },
        });
      } else {
        $.ajax({
          url: "./getShoppingCart.php",
          method: "get",
          data: { vipName: username },
          success(res) {
            getComputedData(JSON.parse(res));
          },
        });
      }
    } else {
      $(".cart-logout").show();
      $(".cart-nothing").show();
      $(".cart-header-right li").eq(1).show();
      $(".cart-header-right li").eq(2).show();
      $(".cart-header-right li").eq(0).hide();
      $(".cart-header-right li").eq(3).hide();
      window.location.href = "http://127.0.0.1/meizu/login.html";
    }
    // 用户点击了立即购买
    function GoBuy(res) {
      let tr = $("<tr></tr>").appendTo(".goodsDetail");
      tr.html(`
      <td class="order-product-table-name">
                    <img src="${res.goodsImg.substring(3)}"  />
                    <div class="order-product-name">
                      <p class="order-product-name-item">${res.goodsName}</p>
                      <p class="order-product-name-item cspu-desc">${selectColor}</p>
                    </div>
      </td>
      <td class="order-product-table-price">
                    <p>${res.goodsPrice}.00 </p>
      </td>
      <td class="order-product-table-num"><i> ${count}</i></td>
      <td class="order-product-table-total">
                    <p>${res.goodsPrice * count}.00</p>
      </td>
      <td class="order-product-table-express" rowspan="999">
                    <p>快递配送：运费</p>
                    <span>￥0.00</span>
      </td>
      `);
      $(".order-product-price").html(res.goodsPrice * count + ".00");
      $(".order-total-price").html(res.goodsPrice * count + ".00");
      $(".order-total-pay1").html(res.goodsPrice * count + ".00");
    }
    // 用户是一步一步从购物车来结算的
    function getComputedData(res) {
      console.log(res);
      let sum = 0;
      for (let i = 0; i < res.length; i++) {
        let trs = $("<tr></tr>").appendTo(".goodsDetail");
        if (i == 0) {
          trs.html(`
      <td class="order-product-table-name">
                    <img src="${res[i].goodsImg.substring(3)}"  />
                    <div class="order-product-name">
                      <p class="order-product-name-item">${res[i].goodsName}</p>
                      <p class="order-product-name-item cspu-desc">${
                        res[i].goodsSelectColor
                      }</p>
                    </div>
      </td>
      <td class="order-product-table-price">
                    <p>${res[i].goodsPrice}.00 </p>
      </td>
      <td class="order-product-table-num"><i> ${res[i].goodsCount}</i></td>
      <td class="order-product-table-total">
                    <p>${res[i].goodsPrice * res[i].goodsCount}.00</p>
      </td>
      <td class="order-product-table-express" rowspan="999">
                    <p>快递配送：运费</p>
                    <span>￥0.00</span>
      </td>
      `);
        } else {
          trs.html(`
      <td class="order-product-table-name">
                    <img src="${res[i].goodsImg.substring(3)}"  />
                    <div class="order-product-name">
                      <p class="order-product-name-item">${res[i].goodsName}</p>
                      <p class="order-product-name-item cspu-desc">${
                        res[i].goodsSelectColor
                      }</p>
                    </div>
      </td>
      <td class="order-product-table-price">
                    <p>${res[i].goodsPrice}.00 </p>
      </td>
      <td class="order-product-table-num"><i> ${res[i].goodsCount}</i></td>
      <td class="order-product-table-total">
                    <p>${res[i].goodsPrice * res[i].goodsCount}.00</p>
      </td>

      `);
        }
        sum += res[i].goodsCount * res[i].goodsPrice;
      }
      $(".order-product-price").html(sum + ".00");
      $(".order-total-price").html(sum + ".00");
      $(".order-total-pay1").html(sum + ".00");
    }
  });
</script>
<script src="./js/compute.js"></script>
